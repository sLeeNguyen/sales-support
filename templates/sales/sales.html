{% extends "core/base.html" %}
{% load static %}

{% block title %}
<title>Sales</title>
{% endblock %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'core/vendor/bootstrap/css/bootstrap.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'core/vendor/fontawesome/css/fontawesome.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'core/vendor/fontawesome/css/solid.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'core/vendor/jquery-ui/jquery-ui.min.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'core/css/sales.css' %}">
{% include 'core/notification_css_js.html' %}
{% endblock %}

{% block content %}
<div class="header">
    <div class="header-search">
        <div class="search-bar">
            <i class="fas fa-search hand"></i>
            <input class="input-border-bottom" type="search" placeholder="Tìm kiếm sản phẩm" oninput="search(this)">
            <div id="search-result" class="result" hidden>
            </div>
        </div>
    </div>
    <div class="tab-invoices px-3 d-flex">
        <ul id="list-tab" class="list-tab">
            <li id="tab-{{oid}}" class="invoice selected hand" oid="{{oid}}">
                <span oid="{{oid}}" onclick="changeTab(this)" style="height: 100%;display: flex;align-items: center;">
                    Hoá đơn {{oid}}</span>
                <i class="fas fa-times ml-1" onclick="removeOrder(this)"></i>
            </li>
        </ul>
        <div id="add-order" class="d-flex align-items-center hand ml-1" onclick="addOrder()"><i class="fas fa-plus"></i></div>
    </div>
    <div class="header-right d-flex align-items-center justify-content-end">
        <div class=""></div>
        <div class="user hand ml-2 bg-hover">
            <i class="fas fa-user-circle"></i>
            <span class="username">{{ user.get_display_name }}</span>
        </div>
        <div class="more hand ml-2 bg-hover"><i class="fas fa-bars"></i></div>
    </div>
</div>
<div class="sell-main d-flex">
    <div class="sell-left p-2">
        {% include 'sales/cart.html' %}
            <!-- <div class="product-item d-flex align-items-center px-2">
                <span class="remove-item ml-3 mr-4"><i class="fas fa-trash ml-1 hand"></i></span>
                <div class="product-item-data row w-100">
                    <div class="product-code col-2" data-toggle="tooltip" title="Mã sản phẩm: SP00002">SP00002</div>
                    <div class="product-name col-6" data-toggle="tooltip" title="Tên sản phẩm: Bim bim">Bim bim</div>
                    <div class="col-1">
                        <input class="product-quantity text-center w-100" type="number" min="0" value="10" title="Số lượng sản phẩm" data-toggle="tooltip">
                    </div>
                    <div class="product-price col-1 text-center" data-toggle="tooltip" title="Giá sản phẩm: 5000">5,000</div>
                    <div class="subtotal col-2 text-center">50000</div>
                </div>
            </div> -->
    </div>
    <div class="sell-right ml-1 mt-3">
        <div class="header-search">
            <div class="search-bar">
                <i class="fas fa-search hand"></i>
                <input class="input-border-bottom" type="search" placeholder="Tìm kiếm khách hàng" oninput="searchCustomer(this)">
                <div id="customer-search-result" class="result" hidden>
                </div>
            </div>
        </div>
        <div class="mt-5 d-flex px-3">
            <span class="px-3 py-1 invoice-title">Hoá đơn</span>
        </div>
        <div class="line mb-4"></div>
        <div class="pr-3 my-3">
            <div class="payment payment-total row">
                <div class="label col-7">Tổng tiền hàng</div>
                <div class="label col-5 fr"><span id="total">0</span></div>
            </div>
            <div class="payment payment-discount row">
                <div class="label col-7">Giảm giá</div>
                <div class="label col-5 fr"><span id="discount">0</span></div>
            </div>
            <div class="payment payment-money row">
                <div class="label col-7 txt-bold">Khách cần trả</div>
                <div class="label col-5 txt-bold fr"><span id="must-pay">0</span></div>
            </div>
            <div class="payment payment-customer-given row">
                <div class="label col-7">Tiền khách đưa</div>
                <div class="label col-5 fr">
                    <input id="customer-given" class="input-border-bottom" type="text" value="0"
                           oninput="formatNumber(this);" onkeypress="validateNumber(event);">
                </div>
            </div>
            <div class="payment payment-refund row">
                <div class="label col-7">Tiền thừa trả khách</div>
                <div class="label col-5 fr"><span id="refund">0</span></div>
            </div>
        </div>
        <div class="note">
            <i class="fas fa-pencil-alt"></i>
            <input id="note" class="input-border-bottom " type="text" placeholder="Ghi chú" oninput="searchCustomer(this)">
        </div>
        <div class="submit d-flex justify-content-center mt-5">
            <button id="payment" type="button" class="btn btn-success mx-2">Thanh toán</button>
            <button id="save" type="button" class="btn btn-success mx-2">Lưu lại</button>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<script src="{% static 'core/vendor/jquery/jquery-3.5.1.min.js' %}"></script>
<script src="{% static 'core/vendor/bootstrap/js/popper.min.js' %}"></script>
<script src="{% static 'core/vendor/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'core/vendor/js-validate/jquery.validate.min.js' %}"></script>
<script src="{% static 'core/js/sales.js' %}"></script>
<script type="text/javascript">
    var cartId = "{{oid}}";
    var numberFormat = new Intl.NumberFormat();

    $(document).ready(function() {
        $("body").click(function() {
            $('#search-result').attr("hidden", true);
        });

        $('[data-toggle="tooltip"]').tooltip();

        $("#save").click(function() {
            if (!validateOrder()) {
                errorNotification({
                    title: "Lỗi!",
                    message: "Đơn hàng không hợp lệ."
                });
                return;
            }
            $.ajax({
                url: `order/${cartId}/`,
                method: "POST",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: {
                    "note": $("#note").val(),
                },
                success: function(data) {
                    if (data.status == "success") {
                        callRemoveOrderApi(`#tab-${cartId}`, cartId);
                        successNotification({
                            title: "Lưu thành công"
                        });
                    } else {
                        console.log(data);
                        errorNotification({
                            title: "Lỗi!",
                            message: data.msg,
                        });
                    }
                },
                error: function() {
                    errorNotification({
                        title: "Xảy ra lỗi!"
                    });
                }
            });
        });

        $("#payment").click(function() {
            if (!validateOrder()) {
                errorNotification({
                    title: "Lỗi!",
                    message: "Đơn hàng không hợp lệ."
                });
                return;
            }
            $.ajax({
                url: `invoice/${cartId}/`,
                method: "POST",
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                data: {
                    "note": $("#note").val(),
                },
                success: function(data) {
                    if (data.status == "success") {
                        $('<iframe>').hide().attr('name', "printIframe").appendTo(document.body);
                        var iFrame = window.frames["printIframe"];
                        iFrame.document.body.innerHTML = data.data;
                        iFrame.focus();
                        iFrame.print();
                        $('<iframe>').remove();
                        callRemoveOrderApi(`#tab-${cartId}`, cartId);
                    } else {
                        errorNotification({
                            title: "Lỗi!",
                            message: data.msg,
                        })
                    }
                }
            });
        });
    });

    function validateOrder() {

        if ($(".available.fas.fa-exclamation-triangle.invalid").length > 0) return false;
        return true;
    }

    function formatNumber(ele) {
        var number = $(ele).val().replaceAll(",", "");
        if (number == "") number = 0;
        numberFormat.format(number);
        $(ele).val(numberFormat.format(number));

        const mustPay = parseInt($("#must-pay").html().replaceAll(",", ""));
        const refund = parseInt(number) - mustPay;
        $("#refund").html(numberFormat.format(refund));
    }

    function validateNumber(evt) {
        var theEvent = evt || window.event;

        // Handle paste
        if (theEvent.type === 'paste') {
            key = event.clipboardData.getData('text/plain');
        } else {
        // Handle key press
            var key = theEvent.keyCode || theEvent.which;
            key = String.fromCharCode(key);
        }
        var regex = /[0-9]|\./;
        if( !regex.test(key) ) {
            theEvent.returnValue = false;
            if(theEvent.preventDefault) theEvent.preventDefault();
        }
    }

    function search(ele) {
        var search_val = $(ele).val();

        if (search_val == "") return;

        $.ajax({
            url: "{% url 'sales:search' %}",
            method: 'GET',
            data: {
                q: search_val
            },
            success: function(data) {
                $("#search-result").empty();
                $("#search-result").append(data);
                $("#search-result").attr("hidden", false);
            }
        });
    }

    function searchCustomer(ele) {

    }

    function changeProductQuantity(ele) {
        let quantity = $(ele).val();
        let productId = $(ele).attr('pid');
        const parent = $(ele).parent().parent();

        let subtotal = parent.find('.subtotal')[0];

        if (quantity == "") {
            quantity = 1;
            $(ele).val(quantity);
        }

        $.ajax({
            url: `cart/${cartId}/`,
            method: 'PATCH',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            data: {
                productId: productId,
                quantity: quantity,
            },
            success: function(data) {
                if (data.status == "failed") {
                    errorNotification({
                        title: "Error",
                        message: data.msg,
                    });
                    $(parent.find('.available')[0]).addClass("invalid");
                } else {
                    $(subtotal).html(numberFormat.format(data.subtotal));
                    $(parent.find('.available')[0]).removeClass("invalid");
                    setPaymentData(data.payment);
                }
            }
        })

        $(".tooltip").remove();
    }

    function addProductItem(ele) {
        const input = $(ele).children()[0];
        const pid = $(input).val();
        $.ajax({
            url: `cart/${cartId}/`,
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            data: {
                productId: pid
            },
            success: function(data) {
                let eid = data.eid;
                if ($(`#${eid}`).length > 0) {
                    $(`#${eid}`).replaceWith(data.order);
                } else {
                    $('#cart').append(data.order);
                }
                $('[data-toggle="tooltip"]').tooltip();
                setPaymentData(data.payment);
            }
        });

        $(".tooltip").remove();
    }

    function removeProductItem(ele) {
        const pid = $(ele).attr('pid');
        $.ajax({
            url: `cart/${cartId}/`,
            method: 'DELETE',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            data: {
                productId: pid
            },
            success: function(data) {
                $('#cart').replaceWith(data.order);
                setPaymentData(data.payment);
            }
        });

        $(".tooltip").remove();
    }

    function addOrder() {
        $.ajax({
            url: "{% url 'sales:order-session' %}",
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(data) {
                $('li.selected').toggleClass('selected');
                $('#list-tab').append(`<li class="invoice selected hand" oid=${data.oid}>
                                            <span oid=${data.oid} onclick="changeTab(this)" style="height: 100%;display: flex;align-items: center;">
                                                Hoá đơn ${data.oid}</span>
                                            <i class="fas fa-times ml-1" onclick="removeOrder(this)"></i>
                                        </li>`);
                cartId = data.oid;
                getOrderData();
            }
        })
    }

    function changeTab(ele) {
        cartId = $(ele).attr('oid');
        getOrderData();
        $('li.selected').toggleClass('selected');
        $($(ele).parent()).addClass('selected');
    }

    function removeOrder(ele) {
        const li_html = $(ele).parent();
        const oid = $(li_html).attr('oid');
        callRemoveOrderApi(li_html, oid);
    }

    function callRemoveOrderApi(li_html, oid) {
        $.ajax({
            url: `order-session/${oid}/`,
            method: 'DELETE',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function() {
                if ($(li_html).hasClass('selected')) {
                    if ($('#list-tab').children().length == 1) {
                        $('#list-tab').append(`<li id="tab-1" class="invoice selected hand" oid=1>
                                                    <span oid=1 onclick="changeTab(this)" style="height: 100%;display: flex;align-items: center;">
                                                        Hoá đơn 1</span>
                                                    <i class="fas fa-times ml-1" onclick="removeOrder(this)"></i>
                                                </li>`);
                        cartId = 1;
                    }
                    else {
                        let currentCart = $('#list-tab').children()[0];
                        $(currentCart).addClass('selected');
                        cartId = $(currentCart).attr('oid');
                    }
                    getOrderData();
                }
                $(li_html).remove();
            },
            error: function() {
                errorNotification({
                    title: "Xảy ra lỗi!"
                })
            }
        });
    }

    function getOrderData() {
        $.ajax({
            url: `order-session/${cartId}/`,
            method: 'GET',
            success: function(data) {
                $('#cart').replaceWith(data.order);
                $('[data-toggle="tooltip"]').tooltip();
                setPaymentData(data.payment);
            }
        });
    }

    function setPaymentData(payment) {
        $("#total").html(numberFormat.format(payment.total));
        $("#must-pay").html(numberFormat.format(payment.mustPay));
        $("#customer-given").val(numberFormat.format(payment.mustPay));
        $("#refund").html(0);
        $("#note").val("");
    }

    function resetPaymentData() {
        $("#total").html(0);
        $("#must-pay").html(0);
        $("#customer-given").val(0);
        $("#refund").html(0);
        $("#note").val("");
    }
</script>
{% endblock %}